<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html>
    <head>
        <title>Apeiron - Admin Panel</title>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <script type="text/javascript" src="/lib/jquery-2.0.1.min.js"></script>
        {% if edit_page %}
        <link rel="stylesheet" type="text/css" href="/lib/pagedown/editor.css" />
        <script type="text/javascript" src="/lib/pagedown/Markdown.Converter.js"></script>
        <script type="text/javascript" src="/lib/pagedown/Markdown.Sanitizer.js"></script>
        <script type="text/javascript" src="/lib/pagedown/Markdown.Editor.js"></script>
        {% endif %}
        {% if config_editor or template_editor %}
        <link rel="stylesheet" type="text/css" href="/lib/pagedown/editor.css" />
        {% endif %}
        <style>
            body
            {
                margin: 0px;
                background: #DDD;
                font-family: Lucida Sans Unicode, Lucida Grande, sans-serif;
            }

            #top_panel
            {
                background:
                linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px,
                linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px,
                linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px,
                linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px,
                linear-gradient(90deg, #1b1b1b 10px, transparent 10px),
                linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);
                background-color: #131313;
                background-size: 20px 20px;

                text-align: center;

                
            }

            select:focus
            {
                outline: none;
            }

            h1
            {
                color: #FFFFFF;
                font-size: 6em;
                font-weight: 100;
            }

            h2
            {
                margin-left: -10px;
                margin-bottom: 10px;
            }

            #login_box
            {
                background: #CCC;
                margin: 0px auto;
                width: 380px;
                height: 200px;
                margin-top: 5em;
                font-size: 15px;
                text-align: left;
                padding-left: 200px;
                color: #444;
                padding-top: 5%;
            }

            #inner_box
            {
                width: 185px;
            }

            #wrap
            {
                min-height: 100%;
            }

            *
            {
                margin:0;padding:0;
            } 

            html, body {height: 100%;}


            #main
            {
                overflow:auto;
                padding-bottom: 25px;
            }  

            #footer
            {
                position: relative;
                margin-top: -30px;
                height: 25px;
                clear:both;

                background:
                linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px,
                linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px,
                linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px,
                linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px,
                linear-gradient(90deg, #1b1b1b 10px, transparent 10px),
                linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);
                background-color: #131313;
                background-size: 20px 20px;

                color: #FFFFFF;
                font-size: 10px;
                text-align: center;
                padding-top: 5px;
            } 

            body:before
            {
                content:"";
                height:100%;
                float:left;
                width:0;
                margin-top:-32767px;
            }

            #footer a 
            {
                color: #FFFFFF;
                text-decoration: none;
            }

            .genok
            {
                color: #336600;
                float: right;
            }

            .genpass
            {
                color: #6666FF;
                float: right;
            }

            .error
            {
                color: #F00;
                float: right;
            }

            input[type=text]
            {
                width: 180px;
            }

            input[type=password]
            {
                width: 180px;
            }

            input[type=submit]
            {
                padding-left: 10px;
                padding-right: 10px;
            }

            ul
            {
                list-style-type: square;
                padding-left: 25px;
                padding-bottom: 15px;
                padding-top: 2px;
            }

            #menu li
            {
                padding-bottom: 2px;
            }

            #main
            {
                margin: 0px auto;
                width: 1100px;
                font-size: 13px;
                overflow: hidden;
                position: relative;
            }

            #menu
            {
                width: 150px;
                padding: 25px;
                float: left;
            }

            #content
            {
                padding: 25px;
                background: #CCC;
                width: 850px;
                float: left;
                border-bottom: thick double #333;
            }

            #edit_page li:before {
                content: "|";
                padding-right: 5px;
            }

            .file_list
            {
                border-left: solid 1px #000;
                margin-left: 20px;
            }

            .file_list td
            {
                padding-left: 5px;
            }


            input[type=text]
            {
                background: #333;
                border: none;
                width: 250px;
                height: 22px;
                color: #EEE;
                font-size: 13px;
                font-family: "Lucida Console", Monaco, monospace;
                padding-left: 8px;
                outline: none;
            }

            input[type=submit], input[type=button]
            {
                background: #333;
                border: none;
                color: #EEE;
                padding: 10px;
                padding-left: 20px;
                padding-right: 20px;
                font-size: 13px;
                font-family: "Lucida Console", Monaco, monospace;
            }

            #login_box input[type=text], input[type=password]
            {
                background: #333;
                border: none;
                width: 176px;
                height: 22px;
                color: #EEE;
                font-size: 13px;
                font-family: "Lucida Console", Monaco, monospace;
                padding-left: 8px;
                outline: none;
            }

            a
            {
                text-decoration: none;
                color: #333;
            }


        </style>
    </head>
    <body>

        <div id="wrap">

            <div id="top_panel">
                <h1>admin panel</h1>
            </div>

            {% if notloggedin %}

            <div id="login_box">
                <div id="inner_box">
                    {% if invalid %}
                        <span style="color: #600;">Invalid login or password!</span>
                    {% endif %}

                    <form method="post">
                        <label for="login">Login: </label><br>
                        <input type="text" name="login"><br>

                        <label for="password">Password: </label><br>
                        <input type="password" name="password">
                        <p style="text-align: right; padding-top: 5px;">
                            <input type="submit" value="Login">
                        </p>
                    </form>

                </div>
            </div>

            {% endif %}

            {% if loggedin %}
            
            <div id="main">
                <div id="menu">
                    <b>Main:</b>
                    <ul>
                        <li>{% if dashboard %}<b>{% endif %}
                            <a href="/">Dashboard</a>
                        {% if dashboard %}</b>{% endif %}</li>
                        <li>{% if generator %}<b>{% endif %}
                            <a href="/generate/">Generate!</a>
                        {% if generator %}</b>{% endif %}</li>
                    </ul>
                    <b>Sections:</b>
                    <ul>
                        {% for section in sections %}
                            <li>{% if section_name == section %}<b>{% endif %}
                                <a href="/section/{{ section }}/">{{ section }}</a>
                                {% if section_name == section %}</b>{% endif %}</li>
                        {% endfor %}
                        <li>{% if section_creator %}<b>{% endif %}
                            <a href="/section/">new section</a>
                            {% if section_creator %}</b>{% endif %}</li>
                    </ul>
                    
                    <b>Settings:</b>
                    <ul>
                        <li>{% if config_editor %}<b>{% endif %}
                            <a href="/config/">Config file</a>
                            {% if config_editor %}</b>{% endif %}</li>
                        <li>{% if template_editor %}<b>{% endif %}
                            <a href="/config/templates/">Templates</a>
                            {% if template_editor %}</b>{% endif %}</li>
                        <li><a href="/logout">Logout</a></li>
                    </ul>
                </div>
                <div id="content">


                    {% if dashboard %}
                        <h2>Dashboard</h2>

                        <table>
                            <tr>
                                <td style="vertical-align: top; width: 300px;">

                                    <h3>Summary:</h3>
                                    <ul>
                                        <li>Default section: {{ default_section }}</li>
                                        <li>Number of sections: {{ sections|length }}</li>
                                        <li>Default template: {{ default_template }}</li>
                                        <li>Output directory: {{ output_directory }}</li>
                                        <li>Static directory: {{ static_directory }}</li>
                                        <li>Admin username: {{ admin_login }}</li>
                                    </ul>

                                </td>
                                <td style="vertical-align: top; width: 300px;">

                                    <h3>Sections:</h3>
                                    <ul>
                                    {% for section in sections %}
                                        <li>
                                            <a href="/section/{{ section }}/">{{ section }}</a>
                                    {% endfor %}
                                    </ul>

                                </td>
                                <td style="vertical-align: top;">

                                    <h3>Actions:</h3>
                                    <ul>
                                        <li><a href="/generate/">Generate</a></li>
                                        <li><a href="/generate/?force">Regenerate everything</a></li>
                                        <br>

                                        <li>Edit templates</li>
                                        <li>Show help</li>
                                        <br>

                                        <li>Delete output directory</li>
                                        <li>Change admin password</li>
                                    </ul>

                                </td>
                            </tr>
                        </table>

                    {% endif %}


                    {% if edit_section %}
                        <h2>{{ section_name }}</h2>
                        <br>
                        <form action="/delete/page/" method="post" id="deleter">
                        <b>Actions:</b> <a href="/section/{{ section_name }}/page/new">Add new page</a> | <a href="javascript:;" id="check_all">Select all</a> |
                            <a href="javascript:;" id="send_post">Delete selected pages</a> | 
                        <a href="/delete/section/{{ section_name }}/">Delete this section</a>
                        <input type="hidden" name="section" value="{{ section_name }}">
                        </form><br><br>

                        <big>{{ section_name }}</big> ({{ section_pages|length }})<br>

                        <script>

                        $(document).ready(function() {
                            $('#check_all').click(function() {
                                if ($('.file_list input:checkbox').prop('checked'))
                                {
                                    $('.file_list input:checkbox').prop('checked',false);
                                    $('#check_all').text('Select all');
                                }
                                else
                                {
                                    $('.file_list input:checkbox').prop('checked',true);
                                    $('#check_all').text('Remove selection');
                                }
                            });

                            $('#send_post').click(function() {

                                var id = 0
                                $('input[type=checkbox]').each(function () {
                                    if (this.checked)
                                    {
                                        $('#deleter').append('<input type="hidden" name="page" value="' + $(this).attr('name') + '">');
                                        id++;
                                    }
                                });

                                if (id)
                                {
                                    if (confirm('All selected pages will be deleted. Are you sure?')) {
                                        $(this).parents('form:first').submit();
                                    }
                                }
                            });
                        });
                        </script>

                        {% if section_pages|length > 0 %}

                            <table class="file_list">
                                <tr style="color: #999;">
                                    <td style="width: 220px; padding-left: 20px;">Title</td>
                                    <td style="width: 150px;">Author</td>
                                    <td style="width: 160px;">Date</td>
                                    <td style="width: 220px;">Filename</td>
                                    <td style="width: 50px;">ID</td>
                                </tr>
                            {% for page in section_pages %}
                                <tr>
                                    <td style="width: 220px;"><input type="checkbox" name="{{ page }}"> <a href="{{ page }}/">{{ section_pages[page].Title }}</a></td>
                                    <td style="width: 150px;">{{ section_pages[page].Author }}</td>
                                    <td style="width: 120px;">{{ section_pages[page].Date }}</td>
                                    <td style="width: 220px;"><a href="{{ page }}/">{{ page }}.md</a></td>
                                    <td style="width: 50px;"><b>{{ section_pages[page].ID }}</td>
                                </tr>
                                
                            {% endfor %}

                            </table>

                            <div style="margin-left: 20px;">
                                &rarr; <a href="/section/{{ section_name }}/page/new">Add new page</a>
                            </div>


                        {% else %}

                            That section is empty!

                        {% endif %}

                    {% endif %}

                    {% if edit_page %}
                        <h2>{{ page }}</h2>
                        File: input/{{ section_name }}/{{ page }}.md<br><br>

                        {% if save_success %}
                            <span class="genok" style="float: left;">Page successfully saved!</span><br><br>
                        {% endif %}

                        <form method="post" name="contents_saver">

                            <table>
                                <tr>
                                    <td style="width: 60px;">
                                        Title:
                                    </td>
                                    <td>
                                        <input type="text" name="title" value="{{ title }}">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Author:
                                    </td>
                                    <td>
                                        <input type="text" name="author" value="{{ author }}">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Tags:
                                    </td>
                                    <td>
                                        <input type="text" name="tags" value="{{ tags }}">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Date:
                                    </td>
                                    <td>
                                        <input type="text" id="date_input" name="date" value="{{ date }}">
                                    </td>
                                    <td>
                                        <input type="button" value="Now" id="now_button" style="height: 22px; padding: 0px; width: 70px;">
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        ID:
                                    </td>
                                    <td>
                                       <input type="text" id="last_input" name="id" value="{{ ID }}">
                                    </td>
                                    <td>
                                        <input type="button" value="Last" id="last_button" style="height: 22px; padding: 0px; width: 70px;">
                                    </td>
                                </tr>
                            </table>

                        <div class="wmd-panel">
                            <div id="wmd-button-bar-content"></div>
                            <textarea class="wmd-input" id="wmd-input-content" name="content">{{ contents }}</textarea>
                        </div>
                        <div id="wmd-preview-content" class="wmd-panel wmd-preview"></div>

                        <script type="text/javascript">
                            (function () {

                                var converter2 = new Markdown.Converter();
                                converter2.hooks.chain("preConversion", function (text) {
                                    return text.replace(/\b(a\w*)/gi, "*$1*");
                                });
                                converter2.hooks.chain("plainLinkText", function (url) {
                                    return "This is a link to " + url.replace(/^https?:\/\//, "");
                                });
                                var options = {
                                    strings: { quoteexample: "whatever you're quoting, put it right here" }
                                };
                                var editor2 = new Markdown.Editor(converter2, "-content", options);
                                
                                editor2.run();
                            })();


                            function validateForm()
                            {

                                var empty_inputs = new Array();

                                $('input[type=text]').each(function(index) {
                                    if ($(this).val() == "" || $(this).val() == null)
                                        empty_inputs.push($(this).attr('name'));
                                });

                                if (empty_inputs.length > 0)
                                {
                                    alert('You have to fill these fields: ' + empty_inputs);
                                    return false;
                                }

                                return true;

                            }

                            function getCurrentDate()
                            {
                                var d = new Date();
                                var curr_date = d.getDate().toString();
                                var curr_month = (d.getMonth() + 1).toString();
                                var curr_year = d.getFullYear().toString();
                                var curr_hour = d.getHours().toString();
                                var curr_minute = d.getMinutes().toString();
                                var curr_sec = d.getSeconds().toString();

                                if (curr_month.length < 2)
                                    curr_month = '0' + curr_month;

                                if (curr_date.length < 2)
                                    curr_date = '0' + curr_date;

                                if (curr_hour.length < 2)
                                    curr_hour = '0' + curr_hour;

                                if (curr_minute.length < 2)
                                    curr_minute = '0' + curr_minute;

                                if (curr_sec.length < 2)
                                    curr_sec = '0' + curr_sec;

                                var output = curr_date + "-" + curr_month + "-" + curr_year + ' ' + curr_hour + ':' + curr_minute + ':' + curr_sec;
                                return output;
                            }

                            function handleButtons()
                            {
                                $("#now_button").click(function() {
                                     $('#date_input').val(getCurrentDate());
                                });

                                $("#last_button").click(function() {
                                     $('#last_input').val('{{ highest_id }}');
                                });
                            }

                            handleButtons();


                        </script>
                        
                            <br>
                            <input type="submit" onclick="return validateForm();" value="Save!" style="float: right; margin-left: 10px;">
                            <input type="submit" onclick="return validateForm();" value="Save and generate!" name="generate" style="float: right;">
                        </form>


                    {% endif %}

                    {% if generator %}

                    <h2>Generator output</h2>
                    <h3>Single pages:</h3>
                        <pre style="background: #333; margin: 30px; color: #DDD; padding: 25px;">
{% for item in pages_feedback -%}
{{ item.replace('OK', '<span class="genok">OK</span>').replace('PASS', '<span class="genpass">PASS</span>')|safe }}
{% endfor %}</pre>
                    <h3>Index pages:</h3>
                        <pre style="background: #333; margin: 30px; color: #DDD; padding: 25px;">
{% for item in index_feedback -%}
{% for subitem in item -%}
{{ subitem.replace('OK', '<span class="genok">OK</span>').replace('ERROR!', '<span class="error">ERROR</span>')|safe }}
{% endfor -%}
{% endfor -%}
                        </pre>

                        <form method="get" style="display: inline;">
                            <input type="submit" value="Generate again">
                        </form>
                        <form method="get" style="display: inline;">
                            <input type="submit" name="force" value="Regenerate everything">
                        </form>


                    {% endif %}

                    {% if section_creator %}

                    <h2>Create new section</h2>

                    <br>

                    {{ section_message }}

                    <form method="post">
                        <label for="login">Section name:</label>
                        <input type="text" name="section" style="width: 250px;"><br>

                        <br>
                        <input type="submit" value="Create section">
                    </form>

                    {% endif %}

                    {% if delete_section %}

                        {% if success %}
                            {{ section }} deleted!
                        {% else %}

                    Do you really want to delete section <b>{{ section }}</b>? This operation cannot be undone! You'll lost all sections page.<br><br>

                    <form method="POST" style="display: inline;">

                         <input type="submit" value="Delete" style="background: #500;">

                    </form>
                    <form method="GET" action="/" style="display: inline;">

                         <input type="submit" value="Cancel">

                    </form>

                        {% endif %}

                    {% endif %}

                    {% if new_page %}

                    <h2>Add new page to <u>{{ section_name }}</u>.</h2>

                    <br>

                    {% if page_status %}

                    <span style="color: #300;">Page already exists or you have no required permissions!</span><br><br>

                    {% endif %}

                    <form method="post">
                        <label for="login">Page name:</label>
                        <input type="text" name="page" style="width: 250px;"><br>

                        <br>
                        <input type="submit" value="Add new page">
                    </form>

                    {% endif %}

                    {% if config_editor %}
                        <h2>Config file editor</h2>
                        {% if save_success %}
                            <span class="genok" style="float: left;">Config saved!</span><br><br>
                        {% endif %}
                        <form method="POST">
                            <textarea class="wmd-input" name="content">{{ config_contents }}</textarea>
                            <input type="submit" value="Save config" style="float: right;">
                        </form>
                    {% endif %}

                    {% if template_editor %}
                        <h2>Templates</h2>
                        {% if save_success %}
                            <span class="genok" style="float: left;">Config saved!</span><br><br>
                        {% endif %}
                        <form type="get">
                        <select name="template" style="padding: 5px; width: 100%; font-family: courier; background: #333; border: 0; color: #FFF; font-size: 16px;" onchange="javascript:this.form.submit();">
                            <option value="">Select template to edit</option>
                            {% for template in templates %}
                                <option value="{{ template }}" {% if template == selected_template %}selected="selected"{% endif %}>{{ template }}</option>
                            {% endfor %}
                        </select>
                        </form>
                        
                        <form method="POST">
                            <textarea class="wmd-input" name="content">{{ template_code }}</textarea>
                            <input type="hidden" name="template" value="{{ selected_template }}">
                            <input type="submit" value="Save template" style="float: right;">
                        </form>
                    {% endif %}

                </div>
            </div>

            {% endif %}
        </div>

        <div id="footer">
            <a href="https://github.com/solusipse/apeiron" target="_blank">Apeiron - static pages generator</a>
        </div>

    </body>
</html>